# Building Incident Response Playbooks for AWS

This project is part of the workshop [Building Incident Response Playbooks for AWS](https://aws-incident-response-playbooks.workshop.aws). Follow the workshop directions for optimal use of this repository contents.

## DO NOT DEPLOY THE CODE FROM THIS REPOSITORY IN AN EXISTING AWS ACCOUNT YOU CURRENTLY USE. CREATE A NEW SANDBOX ACCOUNT FOR THE PURPOSE OF THIS WORKSHOP.

### The stacks will fail deployment with resource name space collision or trying to enable existing services such as Amazon GuardDuty.


## Sandbox environment
* This is a sandbox environment for learning purposes only. You will take the learnings from building a playbook in this controlled environment and adapt to your own environment.
* CloudTrail, VPC Flow, and DNS logs are the fundamental pillars for threat detection and incident response in AWS. Focus on learning how to interpret them based on the activity generated.
* GuardDuty might generate findings depending on the activity generated by the simulations you will run. Focus on observing what activity triggers findings.

## Solving customer challenges around incident response in AWS
* This project builds an environment in an AWS Account facilitating the development of playbooks enhancing customer's capability to respond to security events.
* [Amazon Athena](https://aws.amazon.com/athena/) provides analytical capabilities with pre-configured tables for querying [AWS CloudTrail](https://aws.amazon.com/cloudtrail/) logs, [Amazon VPC Flow logs](https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html), and [Amazon Route53 VPC DNS logs](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resolver-query-logs.html) centralized in An Amazon S3 Bucket.
* Includes two (2) sample playbook addressing the ```IAM credential exposure```, and ```EC2 crypto mining``` threats, plus a ```template``` for you to develop additional scenarios.
* Includes Linux bash scripts to simulate the threats and practice the response laid out by the sample playbooks. Create your own scripts in Linux bash or other languages to support the development and testing of your own security event scenarios.
* [Amazon GuardDuty](https://aws.amazon.com/guardduty/) is configured to assist with detection. Consider using CloudWatch rules to facilitate additional monitoring. 

* * *

## Architecture Overview

There are two stacks, one to deploy the basic components, the ```CoreStack```, and another to create specific resources for simulation purposes, the ```SimulationStack```.

An AWS CDK python application and AWS CloudFormation templates are provided for you to choose how to deploy.


### CoreStack components:
* Amazon S3 Bucket centralizing logs from all configured sources
* Amazon S3 Bucket for Athena queries results
* A VPC with public and private subnets, internet gateway, NAT gateway, and one EC2 instance  
* CloudTrail trail logging management and data events streaming to S3 bucket
* VPC DNS logs enabled for VPC streaming to S3 bucket
* VPC Flow logs enabled for VPC streaming to S3 bucket
* Athena Workgroup
* Glue database and tables
* Security analyst IAM Role to run Athena queries
* Athena administrator IAM Role to configure Athena and Glue
* Security break glass IAM Role for containment, eradication, and recovery
* Security deploy IAM Role for CloudFormation deployment of SimulationStack

![Image](readme-images/cloudformation-designer-CoreStack.png)

### SimulationStack components:
* IAM User Access Key for EC2 crypto mining simulation
* IAM User Access Key for IAM credential exposure simulation

![Image](readme-images/cloudformation-designer-SimulationStack.png)

* * *

## Deployment
* Clone this repository and choose between [AWS CDK](https://docs.aws.amazon.com/cdk/latest/guide/home.html) or [AWS CloudFormation](https://aws.amazon.com/cloudformation/) for deployment of stacks.

### CloudFormation
Preferred deployment method for those with little coding and AWS experience.
* Login to your AWS Account
* Go to the [AWS CloudFormation console](https://console.aws.amazon.com/cloudformation)
* Create stack using cdk/cdk.out/CoreStack.yaml from the cloned repository
* Create stack using cdk/cdk.out/SimulationStack.yaml from the cloned repository

Refer to this page for getting started with [AWS CloudFormation](https://aws.amazon.com/cloudformation/getting-started/).

### AWS CDK
We recommend this method for those with excellent coding and AWS experience.  
* Install ```node.js 10.13.0``` or later
* Install ```Python 3.8``` or later
* Configure a python virtual environment
   * change directory to the root of the cloned repository
   * run ```python -m venv .venv```
   * run ```source .venv/bin/activate```
   * run ```python -m pip install -r stacks/requirements.txt``` 
* Install [AWS CLI v2](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html)
* Create IAM credentials with permission to deploy AWS resources using CloudFormation
* Configure IAM credentials
   * run ```aws configure```
   * verify by running ```aws sts get-caller-identity```
* Install AWS CDK
   * change directory to the root of the cloned repository
   * run ```npm install -g aws-cdk```
   * verify by running ```cdk --version``` to check version installed
* Deploy the AWS CDK app
   * run ```cdk synth```
   * run ```cdk deploy``` 

Refer to this page for getting started with [AWS CDK](https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html)

* * *

## Cost

Consider the costs involved in deploying this solution beyond what is included with [AWS Free Tier](https://aws.amazon.com/free/), if applicable:

* Amazon Athena: https://aws.amazon.com/athena/pricing/
* Amazon S3: https://aws.amazon.com/s3/pricing/
* Amazon EC2: https://aws.amazon.com/ec2/pricing
* AWS CloudTrail: https://aws.amazon.com/cloudtrail/pricing/
* AWS Glue: https://aws.amazon.com/glue/pricing/

* * *

## Related Resources

### AWS resources
* [AWS re:invent 2020: Building your cloud incident response program](https://www.youtube.com/watch?v=MW7kcXL6OVo)
* [AWS Incident Response Playbook Samples (process only)](https://github.com/aws-samples/aws-incident-response-playbooks)
* [AWS Cloud Adoption Framework Security Perspective](https://d0.awsstatic.com/whitepapers/AWS_CAF_Security_Perspective.pdf)
* [AWS Well-Architected labs - Security](https://wellarchitectedlabs.com/security/)
* [GuardDuty Finding Types](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-active.html)
* [AWS Security Analytics Bootstrap](https://github.com/awslabs/aws-security-analytics-bootstrap)
* [AWS API Guides and Documentation](https://docs.aws.amazon.com/index.html)
* [CloudTrail User Guide](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-user-guide.html)
* [Amazon VPC Flow Logs](https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html)
* [Amazon Route53 VPC DNS resolver logs](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/resolver.html)

### Third-party resources
* [NIST Computer Security Incident Handling Guide (Special Publication 800-61 Revision 2)](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-61r2.pdf)

* * *